#!/usr/bin/env bash

echo "lsb_release -a"
lsb_release -a

echo "uname -a"
uname -a

echo "uname -p"
uname -p

echo "uname -i"
uname -i

echo "uname -o"
uname -o

echo "uname -s"
uname -s

echo "uname -v"
uname -v


BIN_DIR=$(cd $(dirname $0); pwd)
ROOT_DIR=$(dirname $BIN_DIR)

build_dir=$1
cache_dir=$2
env_dir=$3

echo "build"
ls -l $build_dir

echo "cache"
ls -l $cache_dir

echo "env"
ls -l $env_dir

echo "compiling"

bins="http://opendylan.org/downloads/opendylan/2013.2/opendylan-2013.2-x86_64-linux.tar.bz2"
targetfile="opendylan.tar.bz2"

#libs="https://www.dropbox.com/s/5jjs3ctm9ej05cc/libgcbins.tar.bz?dl=1"
#targetfile2="libgcbins.tar.bz"

dir="opendylan-2013.2"
#dir2="libgcbins"

# curl $bins -s -o - | tar xjf - -C $builddir
# mkdir opendylan
# cd opendylan
# wget $bins -O $targetfile

# sudo apt-get install libgc-dev

echo "downloading opendylan"
curl -s -o $targetfile $bins

#echo "downloading libs"
#curl -L -s -o $targetfile2 $libs

echo "downlod finish"

if [ ! -f "$targetfile" ]; then
    echo "file doesnt exist"
    exit 2
fi

#if [ ! -f "$targetfile2" ]; then
#    echo "file 2 doesnt exist"
#    exit 2
#fi

echo "extracting opendylan"
tar -jxf $targetfile

#echo "extracting libs"
#tar -jxf $targetfile2

if [ ! -d "`pwd`/$dir/bin" ]; then
    echo "dir doesnt exist"
    exit 2
fi

#if [ ! -d "`pwd`/$dir2" ]; then
#    echo "dir2 doesnt exist"
#    exit 2
#fi

# horrible hack ...
#pushd `pwd`/$dir2
#ln -s libgc.so libgc.so.1
#popd
#ls -l `pwd`/$dir2

echo "dirs exists!"

echo "test compiler"

if [ ! -f "`pwd`/$dir/bin/dylan-compiler" ]; then
    echo "compiler doesnt exist"
    exit 2
fi

echo "some ls"

ls -l `pwd`
ls -l $ROOT_DIR/vendor/libgc

echo "test"

export LD_LIBRARY_PATH=$ROOT_DIR/vendor/libgc
export PATH=$PATH:`pwd`/$dir/bin

dylan-compiler -version    

echo "lets build it!"

cd $build_dir

dylan-compiler -build `find -maxdepth 1 -name "*.lid"`

echo "ok"
exit 1

